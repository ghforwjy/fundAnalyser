# 市值定投算法设计文档

## 核心公式（修正版）

```
1. 基准市值 = 基准日期持仓份额 × 基准日期净值
2. 目标增长额 = 基准市值 × 平均月收益率 × (天数/30)
3. 目标市值 = 基准市值 + 目标增长额
4. 投入金额 = 目标市值 - 当前实际市值
```

**关键改进**：
- 使用**历史持仓份额**作为基准，而非当前持仓份额
- 支持任意日期回溯，不仅限于按月计算
- 区分"原有持仓的盈亏"和"新买入的本金"

---

## 算法说明

### 为什么用历史持仓份额？

假设场景：
- 30天前：持仓 1000 份，净值 10 元，市值 10000 元
- 15天前：买入 500 份（定投）
- 今天：持仓 1500 份，净值 11 元，市值 16500 元

如果用当前份额 1500 计算：
- 错误地认为市值从 15000（1500×10）涨到 16500
- 会把新买入的 5000 元本金当成"盈利"

**正确做法**：
- 只用 30天前的 1000 份作为基准
- 基准市值 = 1000 × 10 = 10000 元
- 目标增长 = 10000 × 1.15% = 115 元
- 目标市值 = 10000 + 115 = 10115 元
- 原有持仓现值 = 1000 × 11 = 11000 元
- 应卖出 = 11000 - 10115 = 885 元（锁定原有持仓的超额收益）
- 新买入的 500 份不参与本期计算，下期再算

---

## 平均月收益率计算

### 基金成立≥5年

- 使用该基金历史数据（近5年）
- 按当前市场阶段（牛市/熊市）计算平均月收益率

### 基金成立<5年

- 使用沪深300/中证500在当前市场阶段的平均月收益率作为参考基准
- 综合参考基准 = (沪深300在当前阶段月收益率 + 中证500在当前阶段月收益率) / 2
- 基准数据缓存有效期：1年

---

## 牛熊市划分

| 时间段 | 市场状态 |
|-------|---------|
| 2021年1月-2月 | 牛市尾声 |
| 2021年3月-2023年12月 | 熊市 |
| 2024年1月-至今 | 牛市 |

---

## 输入参数

| 参数 | 说明 |
|-----|------|
| `fund_code` | 基金代码 |
| `base_date` | 基准日期（如30天前） |
| `target_date` | 目标日期（如今天，可选，默认今天） |
| `shares_at_base` | 基准日期持仓份额（从holding_history表查询） |
| `current_shares` | 当前持仓份额 |
| `avg_monthly_return` | 平均月收益率 |

---

## 输出内容

- 基金基本信息（名称、类型、成立年限）
- 基准日期持仓信息（份额、净值、市值）
- 目标日期实际市值
- 算法说明（计算方法、参考来源）
- 目标市值增长额
- 投入/卖出建议金额
- 12期模拟结果（可选）

---

## 数据缓存策略

| 数据类型 | 缓存位置 | 有效期 | 说明 |
|---------|---------|-------|------|
| 基金平均月收益率 | 内存 | 30天 | 按基金代码+市场阶段缓存 |
| 指数参考基准 | 数据库 | 1年 | 按指数代码+市场阶段缓存 |

**缓存策略说明**：
- 首次计算某基金平均月收益率时，从数据库查询历史净值计算并缓存
- 缓存期内（30天）直接使用缓存值，无需重复查询和计算
- 后端重启后缓存清空，首次计算时会重新生成

---

## 相关接口

| 函数 | 说明 | 示例 |
|-----|------|------|
| `calculate_value_averaging_plan(fund_code, current_holding, simulate)` | 计算市值定投方案 | `calculate_value_averaging_plan('000001', 50000)` |
| `get_value_averaging_report_text(fund_code, current_holding, simulate)` | 获取格式化报告 | `get_value_averaging_report_text('000001', 50000)` |

---

## 使用示例

```python
from smart_fund_data import get_value_averaging_report_text

# 计算定投方案
report = get_value_averaging_report_text('000001', 50000)
print(report)
```

---

## 实现文件

- 算法实现：[value_averaging.py](../value_averaging.py)
- 接口封装：[smart_fund_data.py](../smart_fund_data.py)
