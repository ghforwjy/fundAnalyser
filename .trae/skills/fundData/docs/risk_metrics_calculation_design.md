# 风险指标自计算与验证设计方案

## 一、背景

雪球/蛋卷基金的风险指标数据存在以下问题：
1. 新成立基金（<1年）无数据
2. 数据来源单一，无法验证准确性
3. 需要自己计算以补充缺失数据

## 二、指标计算公式

### 2.1 最大回撤 (Max Drawdown)

```
最大回撤 = max(1 - 当期净值 / 历史最高净值)

计算逻辑：
1. 遍历净值序列，记录历史最高点
2. 计算每个时点相对于历史最高点的回撤
3. 取最大值
```

### 2.2 年化波动率 (Annual Volatility)

```
年化波动率 = 日收益率标准差 × sqrt(252)

计算逻辑：
1. 计算日收益率序列
2. 计算标准差
3. 乘以 sqrt(252) 年化
```

### 2.3 夏普比率 (Sharpe Ratio)

```
夏普比率 = (年化收益率 - 无风险利率) / 年化波动率

其中：
- 年化收益率 = (期末净值/期初净值)^(252/天数) - 1
- 无风险利率 = 2.5% (可配置)
- 年化波动率 = 日收益率标准差 × sqrt(252)
```

### 2.4 区间收益率 (Period Return)

```
区间收益率 = (期末净值 / 期初净值) - 1
```

## 三、数据表设计

### 3.1 复用现有表：fund_risk_metrics

已有表结构足够使用，无需新增表：

```sql
-- 现有表结构
CREATE TABLE IF NOT EXISTS fund_risk_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    fund_code VARCHAR(10) NOT NULL,
    period VARCHAR(20) NOT NULL,              -- 近1年、近3年、近5年、成立以来
    risk_return_ratio INTEGER,                -- 较同类风险收益比（雪球）
    risk_resistance INTEGER,                  -- 较同类抗风险波动（雪球）
    annual_volatility DECIMAL(8,4),           -- 年化波动率
    sharpe_ratio DECIMAL(8,4),                -- 夏普比率
    max_drawdown DECIMAL(8,4),                -- 最大回撤
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(fund_code, period)
)
```

### 3.2 字段扩展（可选）

如需区分数据来源，可添加字段：

```sql
ALTER TABLE fund_risk_metrics ADD COLUMN data_source VARCHAR(20) DEFAULT 'xueqiu';
-- 可选值: 'xueqiu'(雪球), 'calculated'(自计算), 'merged'(合并)
ALTER TABLE fund_risk_metrics ADD COLUMN calc_start_date DATE;
ALTER TABLE fund_risk_metrics ADD COLUMN calc_end_date DATE;
ALTER TABLE fund_risk_metrics ADD COLUMN trading_days INTEGER;
```

### 3.3 对比功能

对比功能不需要单独的表，直接在内存中对比后输出报告即可。

### 3.4 数据存储策略

**全部自行计算**，雪球数据仅用于对比验证：

| 场景 | 操作 |
|------|------|
| 计算成功 | 写入自计算数据，`data_source='calculated'` |
| 雪球有数据 | 对比验证，输出差异报告 |
| 差异过大（>5%） | 标记雪球数据可能过期或有误 |

**原因**：
- 雪球数据可能不更新或过期
- 自计算数据基于最新净值，更可靠
- 对比验证用于发现数据源问题

## 四、计算逻辑设计

### 4.1 新鲜度判断

| 条件 | 操作 |
|------|------|
| 无计算记录 | 需要计算 |
| calc_time 为空 | 需要计算 |
| 最新净值日期 > end_date | 需要重新计算 |
| calc_time 距今 > 7天 | 需要重新计算 |

### 4.2 计算条件与数据获取

| 条件 | 操作 |
|------|------|
| 净值数据不足 | 自动调用 `sync_group_nav` 获取历史净值 |
| 获取成功 | 继续计算 |
| 获取失败（基金已清盘/代码无效） | 跳过并记录到报告 |

**数据获取优先级**：
1. 先检查本地净值数据
2. 不足则自动获取
3. 获取失败才跳过

**周期自适应**：
- 成立满1年：计算近1年、近3年（如有）、近5年（如有）
- 成立不足1年：使用成立以来全部数据计算，周期标记为"成立以来"
- 成立不足半年：仅计算区间收益率，波动率和夏普比率标记为"数据不足"

### 4.3 执行报告

计算完成后生成报告，包含：

```
============================== 风险指标计算报告 ==============================

计算时间: 2026-02-16 15:30:00
组合: 持仓组合 (ID: 2)
基金总数: 20

计算结果:
  成功: 18 只
  跳过: 2 只

成功列表:
  000001 华夏成长混合 - 近1年: 回撤12.48%, 波动率22.48%, 夏普1.55
  000143 鹏华双债加利债券A - 近1年: 回撤4.08%, 波动率7.76%, 夏普2.36
  ...

跳过列表:
  024291 中航月月鑫30天持有期债券C - 原因: 获取净值数据失败

特殊处理:
  021489 中航趋势领航混合发起A - 成立以来(180天): 回撤8.5%, 波动率15.2%, 夏普(数据不足)
  022853 中航优选领航混合发起C - 成立以来(90天): 回撤12.3%, 波动率(数据不足), 夏普(数据不足)

对比结果（自计算 vs 雪球）:
  一致: 15 只
  不一致: 3 只
    - 000001 华夏成长: 最大回撤差异 2.5%（可能原因: 计算时间点不同）
    - ...

=============================================================================
```

### 4.4 周期映射

| 周期 | 所需交易日 | 计算方式 |
|------|-----------|---------|
| 近1年 | 252 | 最近252个交易日 |
| 近3年 | 756 | 最近756个交易日 |
| 近5年 | 1260 | 最近1260个交易日 |

## 五、接口设计

### 5.1 计算函数

```python
def calculate_risk_metrics(fund_code: str, period: str = '近1年') -> Dict[str, Any]:
    """
    计算基金风险指标
    
    Args:
        fund_code: 基金代码
        period: 计算周期（近1年、近3年、近5年）
    
    Returns:
        {
            'fund_code': '000001',
            'period': '近1年',
            'start_date': '2025-02-16',
            'end_date': '2026-02-16',
            'trading_days': 252,
            'period_return': 15.23,
            'annual_return': 15.23,
            'max_drawdown': 12.48,
            'annual_volatility': 22.48,
            'sharpe_ratio': 1.55,
            'risk_free_rate': 0.025
        }
    """
```

### 5.2 对比函数

```python
def compare_risk_metrics(fund_code: str, period: str = '近1年') -> Dict[str, Any]:
    """
    对比自计算与雪球的风险指标
    
    Returns:
        {
            'fund_code': '000001',
            'period': '近1年',
            'calc': {...},
            'xq': {...},
            'diff': {
                'max_drawdown': 0.5,  # 差异0.5%
                'annual_volatility': -0.3,
                'sharpe_ratio': 0.02
            },
            'is_consistent': True,  # 差异<5%认为一致
            'issue': None  # 如果不一致，指出可能的问题
        }
    """
```

### 5.3 批量计算函数

```python
def calculate_portfolio_risk_metrics(portfolio_id: int, force: bool = False) -> List[Dict]:
    """
    计算组合内所有基金的风险指标
    
    Args:
        portfolio_id: 组合ID
        force: 是否强制重新计算
    
    Returns:
        计算结果列表
    """
```

## 六、验证逻辑

### 6.1 一致性判断标准

| 指标 | 允许误差 | 判断 |
|------|---------|------|
| 最大回撤 | ±2% | 差异<2%认为一致 |
| 年化波动率 | ±3% | 差异<3%认为一致 |
| 夏普比率 | ±0.3 | 差异<0.3认为一致 |

### 6.2 不一致原因分析

1. **数据时间点不同**：雪球可能使用不同截止日期
2. **计算方法差异**：夏普比率的无风险利率取值
3. **交易日定义**：是否排除非交易日
4. **净值复权**：是否使用复权净值

## 七、实现步骤

### 第一阶段：核心计算模块
1. 创建数据库表
2. 实现最大回撤计算
3. 实现年化波动率计算
4. 实现夏普比率计算
5. 实现区间收益率计算

### 第二阶段：新鲜度与缓存
1. 实现新鲜度判断逻辑
2. 实现计算结果缓存
3. 实现增量更新

### 第三阶段：对比验证
1. 实现数据对比函数
2. 实现差异分析
3. 生成对比报告

### 第四阶段：集成
1. 集成到聚合查询接口
2. 更新SKILL.md文档

## 八、预期收益

1. **数据完整性**：所有成立1年以上的基金都有风险指标
2. **数据可信度**：自计算与雪球数据对比验证
3. **问题发现**：发现数据源不一致的情况
